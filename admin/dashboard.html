<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Handyman Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      background: #f4f4f4;
    }

    /* Top Navigation Bar */
    .top-nav {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      align-items: center;
      background-color: #2c3e50;
      padding: 12px 20px;
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .top-nav a {
      color: white;
      text-decoration: none;
      margin: 0 12px;
      font-weight: 500;
      transition: color 0.3s;
    }
    .top-nav a:hover { color: #1abc9c; }

    .container {
      max-width: 1000px;
      margin: 80px auto 30px;
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    h1 { text-align: center; color: #333; margin-bottom: 30px; }

    .stats {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #4CAF50;
      color: white;
      padding: 20px;
      border-radius: 10px;
      flex: 1 1 200px;
      margin: 10px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .stat-card h2 { margin: 0 0 10px; font-size: 24px; }
    .stat-card p { margin: 0; font-size: 18px; }

    .recent-activity {
      margin-top: 20px;
    }
    .recent-activity h2 { text-align: left; color: #333; margin-bottom: 15px; }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th { background: #f0f0f0; }

    @media (max-width: 600px) {
      .stats { flex-direction: column; }
      .stat-card { margin: 10px 0; }
      .top-nav { justify-content: center; gap: 8px; }
    }
  </style>
</head>
<body>
  <!-- Top Navigation Bar -->
  <div class="top-nav">
    <a href="dashboard.html">Dashboard</a>
    <a href="customers.html">Customers</a>
    <a href="estimates.html">Estimates</a>
    <a href="#">Expenses</a>
    <a href="#">Reports</a>
    <a href="#">Clientes</a>
    <a href="#">Items</a>
    <a href="#">Settings</a>
    <a id="logoutBtn">Logout</a>
  </div>

  <div class="container">
    <h1>Dashboard</h1>

    <!-- Stats -->
    <div class="stats">
      <div class="stat-card">
        <h2 id="totalCustomers">0</h2>
        <p>Total Customers</p>
      </div>
      <div class="stat-card">
        <h2 id="totalEstimates">0</h2>
        <p>Total Estimates</p>
      </div>
      <div class="stat-card">
        <h2 id="recentEstimates">0</h2>
        <p>Recent Estimates</p>
      </div>
    </div>

    <!-- Recent Activity Table -->
    <div class="recent-activity">
      <h2>Recent Customers</h2>
      <table>
        <thead>
          <tr>
            <th>Name</th><th>Email</th><th>Phone</th><th>Added On</th>
          </tr>
        </thead>
        <tbody id="recentCustomersBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    (async function() {
      try {
        const response = await fetch('/.netlify/functions/firebase-config');
        if (!response.ok) {
          throw new Error('Failed to load Firebase configuration');
        }
        const firebaseConfig = await response.json();
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const logoutBtn = document.getElementById('logoutBtn');
        const totalCustomersEl = document.getElementById('totalCustomers');
        const totalEstimatesEl = document.getElementById('totalEstimates');
        const recentCustomersBody = document.getElementById('recentCustomersBody');

        // Auth protection
        auth.onAuthStateChanged(user => {
          if (!user) window.location.href = "login.html";
          else loadDashboard();
        });

        logoutBtn.addEventListener('click', () => {
          auth.signOut().then(() => window.location.href = "login.html");
        });

        async function loadDashboard() {
          // Total Customers
          const customersSnapshot = await db.collection('customers').get();
          totalCustomersEl.textContent = customersSnapshot.size;

          // Total Estimates
          const estimatesSnapshot = await db.collection('estimates').get();
          totalEstimatesEl.textContent = estimatesSnapshot.size;

          // Recent Customers (last 5)
          db.collection('customers').orderBy('createdAt', 'desc').limit(5)
            .onSnapshot(snapshot => {
              recentCustomersBody.innerHTML = '';
              snapshot.forEach(doc => {
                const c = doc.data();
                const addedOn = c.createdAt ? c.createdAt.toDate().toLocaleDateString() : '';
                const row = `<tr>
                  <td>${c.name}</td>
                  <td>${c.email}</td>
                  <td>${c.phone}</td>
                  <td>${addedOn}</td>
                </tr>`;
                recentCustomersBody.innerHTML += row;
              });
            });
        }
      } catch (error) {
        console.error(error);
      }
    })();
  </script>
</body>
</html>
