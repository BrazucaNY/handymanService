<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Login - Handyman Service</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    * { box-sizing: border-box; font-family: 'Roboto', sans-serif; }
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(to right, #4CAF50, #81C784);
    }
    .login-container {
      background: #fff;
      padding: 40px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      width: 350px;
      text-align: center;
    }
    .login-container h1 { margin-bottom: 30px; color: #333; font-weight: 500; }
    .login-container input {
      width: 100%; padding: 12px 15px; margin: 10px 0;
      border: 1px solid #ccc; border-radius: 8px; font-size: 16px;
    }
    .login-container button {
      width: 100%; padding: 12px; margin-top: 15px;
      border: none; border-radius: 8px; background-color: #4CAF50;
      color: white; font-size: 16px; cursor: pointer; transition: background 0.3s;
    }
    .login-container button:hover { background-color: #388E3C; }
    .error-text { color: red; margin-top: 10px; font-size: 14px; }
  </style>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: window.FIREBASE_CONFIG?.apiKey || "your_firebase_api_key_here",
      authDomain: window.FIREBASE_CONFIG?.authDomain || "handymanserviceadmin.firebaseapp.com",
      projectId: window.FIREBASE_CONFIG?.projectId || "handymanserviceadmin",
      storageBucket: window.FIREBASE_CONFIG?.storageBucket || "handymanserviceadmin.appspot.com",
      messagingSenderId: window.FIREBASE_CONFIG?.messagingSenderId || "your_sender_id",
      appId: window.FIREBASE_CONFIG?.appId || "your_app_id"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>
<body>
  <div class="login-container">
    <h1>Admin Login</h1>
    <form id="loginForm">
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="password" placeholder="Password" required>
      <button type="submit">Login</button>
      <p class="error-text" id="error"></p>
    </form>
  </div>

  <script>
    const loginForm = document.getElementById('loginForm');
    const errorText = document.getElementById('error');

    // Function to get client IP
    async function getClientIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
      } catch (err) {
        return 'unknown';
      }
    }
    loginForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        await firebase.auth().signInWithEmailAndPassword(email, password);
        window.location.href = "admin/admin.html";
      } catch (error) {
        // Get client IP
        let ip = 'unknown';
        try {
          const response = await fetch('https://api.ipify.org?format=json');
          const data = await response.json();
          ip = data.ip;
        } catch(err) {
          console.error("Failed to get IP:", err);
        }

        // Save failed login to Firestore
        db.collection('failed_logins').add({
          email: email,
          ip: ip,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          console.log("Failed login logged:", email, ip);
        }).catch(err => {
          console.error("Error saving failed login:", err);
        });

        // Show message to user
        errorText.textContent = `${error.message}. Your IP (${ip}) has been recorded.`;
      }
    });


    // Redirect logged-in users automatically
    firebase.auth().onAuthStateChanged(function(user) {
      if (user && !window.location.href.includes("admin/admin.html")) {
        window.location.href = "admin/admin.html";
      }
    });

  </script>
</body>
</html>
